# Test runner Dockerfile for .NET 8.0
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS test

# Install useful tools for debugging
RUN apt-get update && apt-get install -y \
    curl \
    vim \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy all project files
COPY scripts/ ./scripts/
COPY tests/ ./tests/

# Restore dependencies for all projects
RUN dotnet restore scripts/shared-xml-to-jsonl/SharedXmlToJsonl.csproj
RUN dotnet restore scripts/pptx-xml-to-jsonl/pptx-xml-to-jsonl.csproj
RUN dotnet restore scripts/xlsx-xml-to-jsonl/xlsx-xml-to-jsonl.csproj
RUN dotnet restore tests/SharedXmlToJsonl.Tests/SharedXmlToJsonl.Tests.csproj
RUN dotnet restore tests/PptxXmlToJsonl.Tests/PptxXmlToJsonl.Tests.csproj

# Build all projects
RUN dotnet build scripts/shared-xml-to-jsonl/SharedXmlToJsonl.csproj -c Release --no-restore
RUN dotnet build scripts/pptx-xml-to-jsonl/pptx-xml-to-jsonl.csproj -c Release --no-restore
# Temporarily skip xlsx build due to similar issues
# RUN dotnet build scripts/xlsx-xml-to-jsonl/xlsx-xml-to-jsonl.csproj -c Release --no-restore

# Build test projects
RUN dotnet build tests/SharedXmlToJsonl.Tests/SharedXmlToJsonl.Tests.csproj -c Release --no-restore
RUN dotnet build tests/PptxXmlToJsonl.Tests/PptxXmlToJsonl.Tests.csproj -c Release --no-restore

# Set default command to run tests
CMD ["dotnet", "test", "--no-build", "-c", "Release", "--logger:trx", "--verbosity", "normal"]